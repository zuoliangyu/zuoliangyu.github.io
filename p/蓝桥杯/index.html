<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="保姆喂饭级教程">
<title>蓝桥杯模板建立</title>

<link rel='canonical' href='https://zuoliangyu.github.io/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/'>

<link rel="stylesheet" href="/scss/style.min.b4286dfbdbdfc37c44356b4643b6a74032e6d4fc30074f5a7c749d7cd89f8c8d.css"><meta property='og:title' content="蓝桥杯模板建立">
<meta property='og:description' content="保姆喂饭级教程">
<meta property='og:url' content='https://zuoliangyu.github.io/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/'>
<meta property='og:site_name' content='左岚'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-06-02T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-06-02T00:00:00&#43;00:00'/><meta property='og:image' content='https://zuoliangyu.github.io/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/test.jpg' />
<meta name="twitter:title" content="蓝桥杯模板建立">
<meta name="twitter:description" content="保姆喂饭级教程"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://zuoliangyu.github.io/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/test.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4876939330698228115.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">左岚</a></h1>
            <h2 class="site-description">一个普通的电子信息工程的摆子大学生</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/zuoliangyu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://space.bilibili.com/27619688'
                        target="_blank"
                        title="bilibili"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1725005390043" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1473" width="24" height="24" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M306.005333 117.632L444.330667 256h135.296l138.368-138.325333a42.666667 42.666667 0 1 1 60.373333 60.373333l-78.037333 77.952L789.333333 256A149.333333 149.333333 0 0 1 938.666667 405.333333v341.333334a149.333333 149.333333 0 0 1-149.333334 149.333333h-554.666666A149.333333 149.333333 0 0 1 85.333333 746.666667v-341.333334A149.333333 149.333333 0 0 1 234.666667 256h88.96L245.632 177.962667a42.666667 42.666667 0 0 1 60.373333-60.373334zM789.333333 341.333333h-554.666666a64 64 0 0 0-63.701334 57.856L170.666667 405.333333v341.333334a64 64 0 0 0 57.856 63.701333L234.666667 810.666667h554.666666a64 64 0 0 0 63.701334-57.813334L853.333333 746.666667v-341.333334A64 64 0 0 0 789.333333 341.333333zM341.333333 469.333333a42.666667 42.666667 0 0 1 42.666667 42.666667v85.333333a42.666667 42.666667 0 1 1-85.333333 0v-85.333333a42.666667 42.666667 0 0 1 42.666666-42.666667z m341.333334 0a42.666667 42.666667 0 0 1 42.666666 42.666667v85.333333a42.666667 42.666667 0 1 1-85.333333 0v-85.333333a42.666667 42.666667 0 0 1 42.666667-42.666667z" p-id="1474" fill="currentColor"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://blog.csdn.net/zl295871597'
                        target="_blank"
                        title="csdn"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1725006916517" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4432" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24"><path d="M512 1024C229.2224 1024 0 794.7776 0 512 0 229.2224 229.2224 0 512 0c282.7776 0 512 229.2224 512 512 0 282.7776-229.2224 512-512 512z m17.066667-413.525333c34.850133 4.352 68.778667 5.12 102.741333 2.0992 23.04-2.048 44.817067-8.362667 64.170667-21.9136 38.212267-26.794667 49.783467-85.1968 24.251733-123.050667-14.626133-21.7088-36.8128-30.344533-60.757333-35.498667-35.054933-7.543467-70.4512-5.751467-105.847467-3.413333-5.666133 0.3584-6.7584 3.072-7.236267 8.209067-3.072 32.682667-6.536533 65.314133-9.813333 97.962666-2.5088 24.814933-4.932267 49.629867-7.509333 75.605334z m53.4016-33.928534c1.962667-20.906667 3.6352-39.338667 5.4272-57.770666 1.553067-15.906133 3.413333-31.778133 4.727466-47.701334 0.3584-4.283733 1.553067-6.656 5.956267-6.382933 15.616 1.041067 31.709867 0.034133 46.728533 3.652267 36.488533 8.823467 48.725333 54.306133 23.3472 83.029333-15.8208 17.902933-36.7616 23.586133-59.255466 25.088-8.465067 0.546133-17.015467 0.085333-26.9312 0.085333zM512 434.295467c-2.184533-0.648533-3.5328-1.1776-4.932267-1.4336-37.717333-6.877867-75.690667-8.328533-113.646933-2.816-20.974933 3.037867-41.0112 9.489067-57.480533 23.330133-22.9888 19.319467-21.640533 46.848 4.4032 62.0032 13.056 7.594667 28.023467 12.509867 42.5984 17.288533 14.08 4.608 28.996267 6.826667 43.144533 11.264 12.5952 3.925333 14.011733 14.318933 3.584 22.306134-3.345067 2.56-7.441067 5.085867-11.537067 5.751466-11.195733 1.826133-22.698667 4.386133-33.826133 3.566934-24.098133-1.774933-48.042667-5.461333-72.5504-8.430934-1.365333 10.615467-2.935467 23.0912-4.5568 35.9424 4.181333 1.365333 7.68 2.730667 11.264 3.618134 33.9456 8.4992 68.386133 9.608533 102.912 5.12 20.087467-2.6112 39.4752-7.901867 56.695467-19.029334 28.603733-18.4832 36.693333-57.1904-4.676267-75.383466-14.506667-6.382933-30.190933-10.410667-45.482667-15.086934-11.4176-3.4816-23.313067-5.614933-34.525866-9.5232-9.7792-3.413333-11.144533-12.202667-3.037867-18.397866 4.6592-3.549867 10.717867-6.997333 16.384-7.3728a480.853333 480.853333 0 0 1 53.384533-0.853334c15.377067 0.699733 30.651733 3.549867 46.4896 5.5296L512 434.295467z m257.143467 2.048L750.933333 614.2976h54.152534c4.778667-45.636267 9.710933-90.7264 14.062933-135.8848 0.6144-6.365867 2.3552-8.840533 8.686933-9.0112 11.434667-0.273067 22.8864-1.979733 34.286934-1.570133 23.722667 0.853333 42.3936 9.728 38.4 43.264-2.901333 24.2688-5.597867 48.571733-8.2432 72.874666-1.092267 10.069333-1.826133 20.189867-2.730667 30.4128h55.330133c3.584-35.259733 7.9872-70.058667 10.496-104.994133 3.413333-47.4624-17.7664-73.3184-64.682666-80.213333-40.96-6.007467-81.339733-0.341333-121.5488 7.133866z m-483.498667 134.6048c-8.738133 1.297067-16.384 2.798933-24.098133 3.4816-25.6512 2.235733-51.319467 3.9424-76.305067-4.266667-13.909333-4.590933-24.6784-12.578133-29.7984-25.9584-7.901867-20.701867 0.887467-47.104 19.831467-60.3136 17.373867-12.117333 37.717333-15.9232 58.453333-15.9232 22.545067-0.017067 45.090133 2.423467 68.232533 3.84L307.2 432.298667c-15.069867-1.723733-29.4912-3.925333-43.997867-4.9152-41.0112-2.798933-80.64 2.6112-117.469866 20.462933-30.020267 14.557867-52.053333 36.010667-58.6752 68.130133-7.850667 38.144 11.537067 69.495467 51.7632 85.845334 19.1488 7.765333 39.287467 12.509867 60.0064 12.5952 24.746667 0.1024 49.493333-1.570133 74.205866-2.952534 3.106133-0.170667 8.311467-2.901333 8.669867-5.034666 1.979733-11.554133 2.730667-23.278933 3.9424-35.464534z" fill="currentColor" p-id="4433"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.zhihu.com/people/zuo-liang-yu-64'
                        target="_blank"
                        title="zhihu"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1725006983608" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6542" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m-90.7 477.8l-0.1 1.5c-1.5 20.4-6.3 43.9-12.9 67.6l24-18.1 71 80.7c9.2 33-3.3 63.1-3.3 63.1l-95.7-111.9v-0.1c-8.9 29-20.1 57.3-33.3 84.7-22.6 45.7-55.2 54.7-89.5 57.7-34.4 3-23.3-5.3-23.3-5.3 68-55.5 78-87.8 96.8-123.1 11.9-22.3 20.4-64.3 25.3-96.8H264.1s4.8-31.2 19.2-41.7h101.6c0.6-15.3-1.3-102.8-2-131.4h-49.4c-9.2 45-41 56.7-48.1 60.1-7 3.4-23.6 7.1-21.1 0 2.6-7.1 27-46.2 43.2-110.7 16.3-64.6 63.9-62 63.9-62-12.8 22.5-22.4 73.6-22.4 73.6h159.7c10.1 0 10.6 39 10.6 39h-90.8c-0.7 22.7-2.8 83.8-5 131.4H519s12.2 15.4 12.2 41.7H421.3z m346.5 167h-87.6l-69.5 46.6-16.4-46.6h-40.1V321.5h213.6v387.3zM408.2 611s0-0.1 0 0z m216 94.3l56.8-38.1h45.6-0.1V364.7H596.7v302.5h14.1z" fill="currentColor" p-id="6543"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://zuoliangyu.github.io/en/" >English</option>
                                
                                    <option value="https://zuoliangyu.github.io/" selected>中文</option>
                                
                                    <option value="https://zuoliangyu.github.io/ar/" >عربي</option>
                                
                            </select>
                        </li>
                    
                
                
                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffec00" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z" />
  <path d="M6.343 17.657l-1.414 1.414" />
  <path d="M6.343 6.343l-1.414 -1.414" />
  <path d="M17.657 6.343l1.414 -1.414" />
  <path d="M17.657 17.657l1.414 1.414" />
  <path d="M4 12h-2" />
  <path d="M12 4v-2" />
  <path d="M20 12h2" />
  <path d="M12 20v2" />
</svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon-stars" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#a905b6" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
  <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2" />
  <path d="M19 11h2m-1 -1v2" />
</svg>
                        <span>暗色模式</span>
                    </li>
                

            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#前言">前言</a>
      <ol>
        <li><a href="#小小的bb几句">小小的bb几句</a></li>
        <li><a href="#锁存器与三八译码器介绍">锁存器与三八译码器介绍</a></li>
        <li><a href="#nop延时函数">NOP延时函数</a></li>
      </ol>
    </li>
    <li><a href="#led蜂鸣器继电器motor模版建立">LED，蜂鸣器，继电器，MOTOR模版建立</a>
      <ol>
        <li><a href="#ledc">Led.c</a>
          <ol>
            <li><a href="#led底层">Led底层</a></li>
            <li><a href="#蜂鸣器继电器motor底层">蜂鸣器，继电器，MOTOR底层</a></li>
          </ol>
        </li>
        <li><a href="#ledh">Led.h</a></li>
      </ol>
    </li>
    <li><a href="#key模版建立">Key模版建立</a>
      <ol>
        <li><a href="#keyc">key.c</a>
          <ol>
            <li><a href="#基础代码">基础代码</a></li>
            <li><a href="#注意事项">注意事项</a></li>
          </ol>
        </li>
        <li><a href="#keyh">key.h</a></li>
      </ol>
    </li>
    <li><a href="#数码管模板建立">数码管模板建立</a>
      <ol>
        <li><a href="#segc">Seg.c</a>
          <ol>
            <li><a href="#数码管编码推导">数码管编码推导</a></li>
            <li><a href="#数码管代码编写">数码管代码编写</a></li>
          </ol>
        </li>
        <li><a href="#segh">Seg.h</a></li>
      </ol>
    </li>
    <li><a href="#ds1302时钟模版建立">Ds1302时钟模版建立</a>
      <ol>
        <li><a href="#ds1302c">Ds1302.c</a>
          <ol>
            <li><a href="#官方的参考代码">官方的参考代码</a></li>
            <li><a href="#我们需要补充的代码">我们需要补充的代码</a></li>
          </ol>
        </li>
        <li><a href="#ds1302h">Ds1302.h</a></li>
      </ol>
    </li>
    <li><a href="#onewire温度模版建立">Onewire温度模版建立</a>
      <ol>
        <li><a href="#onewirec">Onewire.c</a>
          <ol>
            <li><a href="#官方的参考代码-1">官方的参考代码</a></li>
            <li><a href="#我们需要补充的代码-1">我们需要补充的代码</a></li>
          </ol>
        </li>
        <li><a href="#onewireh">Onewire.h</a></li>
      </ol>
    </li>
    <li><a href="#iicpcf8591adda与at24c02eeprom模版建立">IIC（PCF8591(AD/DA)与AT24C02(EEPROM)）模版建立</a>
      <ol>
        <li><a href="#iicc">iic.c</a>
          <ol>
            <li><a href="#官方的参考代码-2">官方的参考代码</a></li>
            <li><a href="#我们需要补充的代码-2">我们需要补充的代码</a></li>
          </ol>
        </li>
        <li><a href="#iich">iic.h</a></li>
      </ol>
    </li>
    <li><a href="#uart串口模版建立">Uart串口模版建立</a>
      <ol>
        <li><a href="#uartc">uart.c</a></li>
        <li><a href="#uarth">uart.h</a></li>
      </ol>
    </li>
    <li><a href="#ul超声波模版建立">Ul超声波模版建立</a>
      <ol>
        <li><a href="#ulc">ul.c</a></li>
        <li><a href="#ulh">ul.h</a></li>
      </ol>
    </li>
    <li><a href="#init初始化模版建立">init初始化模版建立</a>
      <ol>
        <li><a href="#initc">init.c</a></li>
        <li><a href="#inith">init.h</a></li>
      </ol>
    </li>
    <li><a href="#main主函数书写">main主函数书写</a>
      <ol>
        <li><a href="#mainc">main.c</a>
          <ol>
            <li><a href="#全部变量的归纳">全部变量的归纳</a></li>
            <li><a href="#数据读取模块">数据读取模块</a></li>
            <li><a href="#key键盘模块">Key键盘模块</a></li>
            <li><a href="#seg数码管模块">Seg数码管模块</a></li>
            <li><a href="#led灯模块">Led灯模块</a></li>
            <li><a href="#uart串口模块">Uart串口模块</a></li>
            <li><a href="#定时器0初始化ne555模块">定时器0初始化（NE555模块）</a></li>
            <li><a href="#定时器1初始化">定时器1初始化</a></li>
            <li><a href="#定时器1中断重点">定时器1中断（重点）</a></li>
            <li><a href="#串口中断这里代码写死">串口中断（这里代码写死）</a></li>
            <li><a href="#main主函数书写-1">main主函数书写</a></li>
            <li><a href="#完整的mainc">完整的main.c</a></li>
          </ol>
        </li>
        <li><a href="#mainh">main.h</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/">
                <img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/test_hu3872941962256208039.jpg"
                        srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/test_hu3872941962256208039.jpg 800w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/test_hu5296626932472258094.jpg 1600w"
                        width="800" 
                        height="448" 
                        loading="lazy"
                        alt="Featured image of post 蓝桥杯模板建立" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E8%93%9D%E6%A1%A5%E6%9D%AF/" style="background-color: #2a9d8f; color: #fff;">
                蓝桥杯
            </a>
        
            <a href="/categories/%E5%8D%95%E7%89%87%E6%9C%BA/" >
                单片机
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/">蓝桥杯模板建立</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            保姆喂饭级教程
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 02, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 29 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>[toc]</p>
<h2 id="前言">前言
</h2><h3 id="小小的bb几句">小小的bb几句
</h3><p>这里我说明一下我个人在学习单片机的时候的一些心得体会，以及大模板的最新建立，会持续更新。</p>
<p>最基础的模版来自于B站Up <a class="link" href="https://space.bilibili.com/1041194501"  target="_blank" rel="noopener"
    >Alice_西风的个人空间-Alice_西风个人主页-哔哩哔哩视频 (bilibili.com)</a></p>
<p>我的B站为<a class="link" href="https://space.bilibili.com/27619688"  target="_blank" rel="noopener"
    >左-岚的个人空间-左-岚个人主页-哔哩哔哩视频 (bilibili.com)</a></p>
<p>这篇文章对应着我B站的视频为 <a class="link" href="https://www.bilibili.com/video/BV1F4421Q7Jg/"  target="_blank" rel="noopener"
    >【蓝桥杯】【单片机】大模板构建喂饭教程</a></p>
<p>建议搭配着视频使用，不然可能有些地方比较迷糊。</p>
<p>用到的压缩包和这个pdf的百度网盘链接</p>
<blockquote>
<p>链接：https://pan.baidu.com/s/1LhlBR7eKAB4A4sbvkHtiJw?pwd=mvin
提取码：mvin
&ndash;来自百度网盘超级会员V4的分享</p>
</blockquote>
<p>对应的CSDN链接为<a class="link" href="https://blog.csdn.net/zl295871597/article/details/139519652?"  target="_blank" rel="noopener"
    >【喂饭】【速成】蓝桥杯模版手把手建立-CSDN博客</a></p>
<p>对应的知乎链接为<a class="link" href="https://zhuanlan.zhihu.com/p/702140525"  target="_blank" rel="noopener"
    >【喂饭】【速成】蓝桥杯模版手把手建立</a></p>
<p>这两个仓库可以删除后面的东西（一直删除到master，可以看到我的全部的东西）</p>
<p>Github的仓库为 <a class="link" href="https://github.com/zuoliangyu/lanqiaobei_study/tree/master/%e6%a8%a1%e6%9d%bf/demo_zuolan"  target="_blank" rel="noopener"
    >lanqiaobei_study/模板/demo_zuolan at master · zuoliangyu/lanqiaobei_study (github.com)</a>
Gitee的仓库为 <a class="link" href="https://gitee.com/zuo-lan/blue-bridge-cup-learning/tree/master/%e6%a8%a1%e6%9d%bf/demo_zuolan"  target="_blank" rel="noopener"
    >模板/demo_zuolan · zuoliangyu/蓝桥杯学习 - 码云 - 开源中国 (gitee.com)</a></p>
<h3 id="锁存器与三八译码器介绍">锁存器与三八译码器介绍
</h3><p>这里我们需要有一个基础知识，就是我们的锁存器和三八译码器介绍，这是一个比较关键的点，我们看到下面这两个图，可以看到我们的锁存器是用P25，P26，P27进行控制，即P2的高三位进行的控制，我们只需要按照如下的命令进行书写即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mi">0</span><span class="n">x</span><span class="o">?</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中的P2&amp;=0x1f，表示我们将高三位置为0，| 0x?0的操作表明我们对高三位进行书写，比如Y4C，那么就代表我们的高三位要表示为4，即0100，我们将其放在高位，即<strong>100</strong>0_0000，翻译过来就是0x80</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102849364.png"
	width="1433"
	height="590"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102849364_hu14383052888467227716.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102849364_hu9660836311553001166.png 1024w"
	loading="lazy"
	
		alt="image-20240603102849364"
	
	
		class="gallery-image" 
		data-flex-grow="242"
		data-flex-basis="582px"
	
></p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102505211.png"
	width="1252"
	height="664"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102505211_hu13833016508639761421.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102505211_hu5475462814160983489.png 1024w"
	loading="lazy"
	
		alt="image-20240603102505211"
	
	
		class="gallery-image" 
		data-flex-grow="188"
		data-flex-basis="452px"
	
></p>
<h3 id="nop延时函数">NOP延时函数
</h3><p>这里要注意一个问题，就是我们延时函数大部分都有NOP，包括Ds1302，IIC都使用了这个，这个函数存在于头文件intrins.h中，需要注意一下引用，一般来说，一个NOP在12MHz的单片机下是1us，其余的自己去换算一下。</p>
<h2 id="led蜂鸣器继电器motor模版建立">LED，蜂鸣器，继电器，MOTOR模版建立
</h2><h3 id="ledc">Led.c
</h3><blockquote>
<p>这里虽然名称叫做Led.c，但是里面书写LED，蜂鸣器，继电器，MOTOR的代码</p>
</blockquote>
<h4 id="led底层">Led底层
</h4><p>我们可以看到Led的代码，我们可以注意到的是，这个地方使用了static这个关键词，因为我们需要关注内存的使用~~（这里不得不提C51的垃圾内存容量）~~，所以我们将其变为函数静态内存，可以有效节省。</p>
<p>传入的参数有两个，一个是addr，代表我们需要控制的Led的地址，（0-7）对应了（L1-L8），另一个是enable，用于控制选中的Led灯的亮灭。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Led_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enable</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们定义了两个参数，一个是temp，一个是temp_old，你们可能会好奇，为什么我要在这里用两个变量来进行编写，明明逻辑上只需要用一个变量对P0进行赋值就行了，这里我说明一下，我们一般情况下不会一直操控锁存器，否则有概率影响数码管的显示，当我们状况出现变化（temp!=temp_old）的时候，我们才对锁存器P2的高三位进行书写。当我们需要点亮的时候，就让相应的addr变为1；当我们需要熄灭的时候就让相应的addr变为0；</p>
<blockquote>
<p>这里你可能会有疑问，因为我们在原理图上面如果想让Led亮，那么应该给0，这里做一个说明，我们后面会直接取反，这里用1是为了符合我们的直觉~~（因为正常人就是1亮0灭）~~</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_old</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102116772.png"
	width="912"
	height="515"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102116772_hu3415044998637222960.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603102116772_hu16624705189952345542.png 1024w"
	loading="lazy"
	
		alt="image-20240603102116772"
	
	
		class="gallery-image" 
		data-flex-grow="177"
		data-flex-basis="425px"
	
></p>
<p>我们通过查看原理图可以看到，用于控制的Load为Y4C，我们通过计算二进制可以发现结果为1000_0000，即0x80，所以我们在这里代码中的P2设置为P2 = P2 &amp; 0x1f | 0x80;在运行后别忘记使用P2 &amp;= 0x1f来进行高位清零，但是在我们操作P2锁存器之前，我们需要先对P0进行赋值（要记得先取反）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">temp_old</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P0</span> <span class="o">=</span> <span class="o">~</span><span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_old</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">/// @brief Led扫描
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">/// @param addr 需要控制的Led的地址（0-7）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">/// @param enable 控制该地址的Led是否点亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">Led_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_old</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">temp_old</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">P0</span> <span class="o">=</span> <span class="o">~</span><span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_old</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="蜂鸣器继电器motor底层">蜂鸣器，继电器，MOTOR底层
</h4><p>这里我就一起讲了，因为他们三是一个芯片的不同输出，和上方的Led类似，但是这几个需要一个全局变量（在函数外申明）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_old_0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，BUZZ、MOTOR、RELAY为一个芯片的不同位的输出</p>
<p>RELAY对应I5-&gt;Q4-&gt;D4-&gt;0001_0000-&gt;0x10</p>
<p>MOTOR对应I6-&gt;Q5-&gt;D5-&gt;0010_0000-&gt;0x20</p>
<p>BUZZ对应I7-&gt;Q6-&gt;D6-&gt;0100_0000-&gt;0x80</p>
<p>这里后我们就知道如果我们需要对应的工作，那么就要给P0赋相应的值，并且下方的Y5C也告诉我们，我们需要给锁存器为1010_0000-&gt;0xa0,即P2 = P2 &amp; 0x1f | 0xa0;这个之后也别忘了使用P2 &amp;= 0x1f来进行高位清零。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">temp_0</span> <span class="o">!=</span> <span class="n">temp_old_0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_old_0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603110637349.png"
	width="1078"
	height="507"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603110637349_hu7432846676362568503.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603110637349_hu12611569139483090476.png 1024w"
	loading="lazy"
	
		alt="image-20240603110637349"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="510px"
	
></p>
<p>总体代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_old_0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// @brief 蜂鸣器控制
</span></span></span><span class="line"><span class="cl"><span class="c1">/// @param enable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Beep</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">temp_0</span> <span class="o">!=</span> <span class="n">temp_old_0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_old_0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// @brief 继电器控制
</span></span></span><span class="line"><span class="cl"><span class="c1">/// @param enable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Relay</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">temp_0</span> <span class="o">!=</span> <span class="n">temp_old_0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_old_0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// @brief MOTOR控制
</span></span></span><span class="line"><span class="cl"><span class="c1">/// @param enable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">MOTOR</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">temp_0</span> <span class="o">!=</span> <span class="n">temp_old_0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">P0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_old_0</span> <span class="o">=</span> <span class="n">temp_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ledh">Led.h
</h3><p>申明代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">Led_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Beep</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Relay</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">MOTOR</span><span class="p">(</span><span class="n">bit</span> <span class="n">enable</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="key模版建立">Key模版建立
</h2><h3 id="keyc">key.c
</h3><h4 id="基础代码">基础代码
</h4><p>在这里我们可以看到原理图里面的行列显示，最新版的原理图把row和col单独拿出来了，所以可能对应有点麻烦~~（其实也不麻烦）~~，如下图所示，我们直接按照一列一列进行扫描，给列低电平后判断指定行是否为低电平，如果指定行为低电平，那么我们就认为这个按键被按下。并且我们在这里不需要实现消抖等操作，我们会在main.c里面实现我们的功能，这里只实现最基础的扫描。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112443055.png"
	width="951"
	height="304"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112443055_hu18361283495730243760.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112443055_hu1996956923984371888.png 1024w"
	loading="lazy"
	
		alt="image-20240603112443055"
	
	
		class="gallery-image" 
		data-flex-grow="312"
		data-flex-basis="750px"
	
></p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112417611.png"
	width="1173"
	height="503"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112417611_hu8278596072554563945.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603112417611_hu5035428298303839418.png 1024w"
	loading="lazy"
	
		alt="image-20240603112417611"
	
	
		class="gallery-image" 
		data-flex-grow="233"
		data-flex-basis="559px"
	
></p>
<p>在我们把行列扫描写完后就可以完成工作了，但是，我们要注意一个问题，局部变量一定要注意初始化为0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="注意事项">注意事项
</h4><p>在这里要注意一个问题，我们的串口进行发送的时候会占用P30和P31口，这个是硬件的冲突，所以我们在进入这个扫描函数的时候，需要对其关掉轮询（就是在main函数里面用的什么来进行各个函数定时的定时器，叫做轮询定时器）。这里我用的是定时器1，所以我进入后就要使用ET1=0关掉，结束后用P3=0xff；ET1=1开启。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ET1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">----</span>
</span></span><span class="line"><span class="cl"><span class="n">P3</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ET1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有一个比较重要的问题，今年（2024）不管是省赛还是国赛都考了ne555的测量，我们ne555的测量要用到P34引脚，也就是我们的按键的最后一列，那么这里就要注意一下，这是一个硬件冲突，且无法解决，所以我们将所有P34删除，就当我们用的按键为4行3列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>整体代码如下（没有包括ne555，如果有ne555需要把按键扫描换成上面的）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;key.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Key_Read</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ET1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P44</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P44</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P35</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">P34</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P33</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P31</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">P30</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P3</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ET1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="keyh">key.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Key_Read</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="数码管模板建立">数码管模板建立
</h2><h3 id="segc">Seg.c
</h3><h4 id="数码管编码推导">数码管编码推导
</h4><p>这里我单独开一个标题来做数码管的编码推导，因为这个很重要，我们看到下方的截图</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603114712357.png"
	width="161"
	height="233"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603114712357_hu12584209621601091620.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603114712357_hu13639775162123981723.png 1024w"
	loading="lazy"
	
		alt="image-20240603114712357"
	
	
		class="gallery-image" 
		data-flex-grow="69"
		data-flex-basis="165px"
	
></p>
<p>可以观察到每一段的数码管都被编号，这里由于我们用的是共阳极数码管，即0亮1灭，下面我给一个🌰来进行说明</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603115210566.png"
	width="369"
	height="397"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603115210566_hu1075107953114589668.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603115210566_hu2741314869135731472.png 1024w"
	loading="lazy"
	
		alt="image-20240603115210566"
	
	
		class="gallery-image" 
		data-flex-grow="92"
		data-flex-basis="223px"
	
></p>
<p>我们标好后按照dp-&gt;g-&gt;…-&gt;a的顺序写出，即1010_0100-&gt;0xa4，这个值在数码管的显示中就代表着“2”</p>
<p>所以我们就可以根据这个规律来编写一个段选表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">code</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seg_dula</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="数码管代码编写">数码管代码编写
</h4><p>这是我们最最重要的玩意，因为这个涉及到我们的显示，我们看原理图可以看到，我们需要对数码管进行位选（选择哪一个数码管进行显示），段选（选择数码管显示的数据）。</p>
<p>其中ABCDEFG和DP为我们的段选，COM1-8为我们的位选</p>
<p>我们需要先对P0进行段选显示后，使用P2将锁存器打开（Y7C-&gt;1110_0000-&gt;0xe0）;在对P0进行位选配置后，使用P2将锁存器打开（Y6C-&gt;1100_0000-&gt;0xc0）</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603113818447.png"
	width="1118"
	height="652"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603113818447_hu803280859110359360.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603113818447_hu14165066156013377168.png 1024w"
	loading="lazy"
	
		alt="image-20240603113818447"
	
	
		class="gallery-image" 
		data-flex-grow="171"
		data-flex-basis="411px"
	
></p>
<p>经过我们的分析后我们就可以知道我们需要传入的数据为wela位选，dula段选，point是否显示小数点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Seg_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wela</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dula</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">point</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们为了避免闪烁，所以我们需要先对数码管进行消隐，即</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后我们对位置进行选择后使用P2打开相应锁存器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P0</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">wela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于我们可以知道，要显示小数点的话，我们就要让DP为0，其他不变，即&amp;0x7f即可完成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">P0</span> <span class="o">=</span> <span class="n">seg_dula</span><span class="p">[</span><span class="n">dula</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="n">P0</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>总体代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;seg.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 0-9 灭
</span></span></span><span class="line"><span class="cl"><span class="c1">//  A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">code</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seg_dula</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Seg_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wela</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dula</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">point</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 消隐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">P0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 位选
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">P0</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="n">wela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 段选
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">P0</span> <span class="o">=</span> <span class="n">seg_dula</span><span class="p">[</span><span class="n">dula</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="n">P0</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xe0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="segh">Seg.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">Seg_Disp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wela</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dula</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">point</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ds1302时钟模版建立">Ds1302时钟模版建立
</h2><h3 id="ds1302c">Ds1302.c
</h3><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接对下方的时间读取/写入进行操作</p>
<h4 id="官方的参考代码">官方的参考代码
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	# 	DS1302代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SDA</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Read_Ds1302_Byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">SDA</span><span class="p">)</span> <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SDA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SDA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="我们需要补充的代码">我们需要补充的代码
</h4><p>首先是我们需要绑定SDA，RST，SCK的引脚，在原理图中可以看到，并且要注意一个问题，我们用到了NOP函数，所以需要引入头文件intrins.h</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120352094.png"
	width="811"
	height="169"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120352094_hu2439202099987694672.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120352094_hu7776420797589992101.png 1024w"
	loading="lazy"
	
		alt="image-20240603120352094"
	
	
		class="gallery-image" 
		data-flex-grow="479"
		data-flex-basis="1151px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">SDA</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">RST</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">SCK</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">7</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就是我们的读写时钟，观察芯片手册可以看到</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120847616.png"
	width="1005"
	height="460"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120847616_hu14979945308175453964.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603120847616_hu12440655097310099549.png 1024w"
	loading="lazy"
	
		alt="image-20240603120847616"
	
	
		class="gallery-image" 
		data-flex-grow="218"
		data-flex-basis="524px"
	
></p>
<p>我们如果需要读取时钟的话，只需要读取地址0x85-&gt;小时 0x83-&gt;分钟 0x81-&gt;秒钟</p>
<p>我们如果需要写入时钟的话，需要先将0x8E位置的最高位WP置0，解除写保护后才能进行写入，写入的地址为0x84-&gt;小时 0x82-&gt;分钟 0x80-&gt;秒钟</p>
<p>所以我们的代码编写就很简单了,我们传入数据为数组的指针</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Set_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Read_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里给一个调用的示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">time</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">};</span><span class="c1">//11:12:13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Set_Rtc</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">Read_Rtc</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在写入之前需要进行解锁写保护，写完后就进行写保护</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">-----</span>
</span></span><span class="line"><span class="cl"><span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们在使用的过程中可以直接使用for循环进行读取/写入，由于我们为了方便，所以我们在这里使用十进制进行存储和读取（本质上存储和读取的都是二进制BCD码，比如0x11我们读取为11，写入为11，在里面内部使用变量进行转换）</p>
<p>举个🌰，我们假设要写入的时间为23:59:58，那么我们实际上要写入芯片的数据为0x23 0x59 0x58</p>
<p>但是我们为了方便（因为有时候需要我们是设置时钟，加减的那种，直接使用bcd码不方便，需要我们判断是否达到0xa0然后进行转换），这里我们可以在里面写一个十进制转为十进制bcd码的公式就行，以写入0x23为例，我们输入给我们Set_Rtc函数的数据为23，我们要先将其转换为0x23才能进行写入，那么我们可以观察一下，本质上就是把十位和个位分开，然后再存入即可，我们分开很简单，直接/10和%10就可以取出十位和个位，然后再使用&laquo;4来进行高位移位，将我们的十位移动到高四位去，然后|上我们的个位（低四位）就可以将其拼接完成。</p>
<p>23-&gt;2,3-&gt;0010,0011-&gt;0100_0011</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>同理，我们读取的时候读取到的都是十进制的bcd码，那么我们将其转换后再读出</p>
<p>0x23-&gt;0x2,0x3-&gt;2*10+3-&gt;23</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>读取和写入的代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//写入 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x84</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="nf">Read_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x85</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要补充的完整代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 十进制 11 -&gt; 0x11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Set_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x84</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 十进制 0x11 -&gt; 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Read_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="nf">Read_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x85</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	# 	DS1302代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ds1302.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">SDA</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">RST</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">SCK</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SDA</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Read_Ds1302_Byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">SDA</span><span class="p">)</span> <span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">RST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCK</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SDA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SDA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 十进制 11 -&gt; 0x11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Set_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x84</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 十进制 0x11 -&gt; 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Read_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="nf">Read_Ds1302_Byte</span><span class="p">(</span><span class="mh">0x85</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ucRtc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ds1302h">Ds1302.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">Set_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Read_Rtc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucRtc</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="onewire温度模版建立">Onewire温度模版建立
</h2><h3 id="onewirec">Onewire.c
</h3><h4 id="官方的参考代码-1">官方的参考代码
</h4><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接对下方的进行温度读取操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	# 	单总线代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="n">dat</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dat</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Read_DS18B20</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dat</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">DQ</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">dat</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">bit</span> <span class="nf">init_ds18b20</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">bit</span> <span class="n">initflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">initflag</span> <span class="o">=</span> <span class="n">DQ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">initflag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="我们需要补充的代码-1">我们需要补充的代码
</h4><p>首先是我们需要绑定DQ的引脚，在原理图中可以看到</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151248313.png"
	width="650"
	height="72"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151248313_hu9446080134829910621.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151248313_hu10853149963321804921.png 1024w"
	loading="lazy"
	
		alt="image-20240603151248313"
	
	
		class="gallery-image" 
		data-flex-grow="902"
		data-flex-basis="2166px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">DQ</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">4</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们不需要管上方的时序的书写，只需要进行温度读取的代码书写就行，</p>
<p>下方是温度芯片的使用顺序（官方手册），首先我们需要运行init，然后再检查rom（可跳过），最后执行我们的功能函数，注意，一次只能使用一个功能。</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151648898.png"
	width="939"
	height="288"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151648898_hu18225334529181485370.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151648898_hu13828731489360069612.png 1024w"
	loading="lazy"
	
		alt="image-20240603151648898"
	
	
		class="gallery-image" 
		data-flex-grow="326"
		data-flex-basis="782px"
	
></p>
<p>我们可以在官方手册上找到需要运行的指令</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151943165.png"
	width="1058"
	height="322"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151943165_hu14013671745411534892.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603151943165_hu15009256727652979763.png 1024w"
	loading="lazy"
	
		alt="image-20240603151943165"
	
	
		class="gallery-image" 
		data-flex-grow="328"
		data-flex-basis="788px"
	
></p>
<p>当我们发送0xcc的时候，就会跳过ROM检查，并且这里也说明了，我们发送0x44就可以开启温度转换，发送0xbe就可以开始读取温度，但是要注意一个事情，我们同样可以在我们的官方的手册上面找到一段读取的语句，这里表明我们先读取低位，再读取高位，最后将其拼接后再*精度就是我们的数据了</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152342393.png"
	width="959"
	height="658"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152342393_hu7194118573535760631.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152342393_hu5042503082427233033.png 1024w"
	loading="lazy"
	
		alt="image-20240603152342393"
	
	
		class="gallery-image" 
		data-flex-grow="145"
		data-flex-basis="349px"
	
></p>
<p>温度的精度在文档中对应如下</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152557565.png"
	width="912"
	height="340"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152557565_hu17149874912480160735.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603152557565_hu15813524116178136631.png 1024w"
	loading="lazy"
	
		alt="image-20240603152557565"
	
	
		class="gallery-image" 
		data-flex-grow="268"
		data-flex-basis="643px"
	
></p>
<p>精度为9-&gt;0.5;10-&gt;0.25;11-&gt;0.125;12（默认）-&gt;0.0625</p>
<p>我们就可以根据上面的描述来进行代码书写</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">rd_temperature</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//开启温度转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">init_ds18b20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xcc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0x44</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//开启温度读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">init_ds18b20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xcc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">low</span> <span class="o">=</span> <span class="nf">Read_DS18B20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">high</span> <span class="o">=</span> <span class="nf">Read_DS18B20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">low</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0625</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里给一个调用示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">temp</span> <span class="o">=</span> <span class="nf">rd_temperature</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	# 	单总线代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;onewire.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">DQ</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="n">dat</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dat</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Read_DS18B20</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dat</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">DQ</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">dat</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">dat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">bit</span> <span class="nf">init_ds18b20</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">bit</span> <span class="n">initflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">DQ</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">initflag</span> <span class="o">=</span> <span class="n">DQ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">initflag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">rd_temperature</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">init_ds18b20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xcc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0x44</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay_OneWire</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">init_ds18b20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xcc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Write_DS18B20</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">low</span> <span class="o">=</span> <span class="nf">Read_DS18B20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">high</span> <span class="o">=</span> <span class="nf">Read_DS18B20</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">low</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0625</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="onewireh">Onewire.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">float</span> <span class="nf">rd_temperature</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="iicpcf8591adda与at24c02eeprom模版建立">IIC（PCF8591(AD/DA)与AT24C02(EEPROM)）模版建立
</h2><h3 id="iicc">iic.c
</h3><h4 id="官方的参考代码-2">官方的参考代码
</h4><p>这里有官方提供的参考代码，所以我们上面的时序可以不用书写，我们直接进行AD读取与DA输出还有AT24C02的存储操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	#   I2C代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DELAY_TIME 10
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">I2C_Delay</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CStart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CStop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CSendByte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">byt</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">I2CReceiveByte</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">da</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">da</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sda</span><span class="p">)</span> <span class="n">da</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">da</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">I2CWaitAck</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ackbit</span> <span class="o">=</span> <span class="n">sda</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CSendAck</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ackbit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="我们需要补充的代码-2">我们需要补充的代码
</h4><p>首先是我们需要绑定sda和scl的引脚，在原理图中可以看到，并且要注意一个问题，我们用到了NOP函数，所以需要引入头文件intrins.h</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603153405955.png"
	width="758"
	height="701"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603153405955_hu10437034729705518258.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603153405955_hu13958489575452418832.png 1024w"
	loading="lazy"
	
		alt="image-20240603153405955"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="259px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">scl</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">sda</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我在这里需要说明一下IIC通信的方式，他是一个一个八位的数据，其中第一位是我们的发送地址，永远都是1，然后后面挂载了不同的外设，我们的蓝桥杯的板子挂了两个外设，一个是PCF8591，对应着AD/DA的功能；另一个是AT24C02，对应着EEPROM的存储功能。在我们板子上就长我们下面这个样子~~（我画的有点抽象）~~，所以我们就可以知道，如果我们要对AT24C02芯片写入数据的话，我们就需要使用地址为（1010_0000-&gt;0xa0），要读取数据的化，我们就要使用地址为（1010_0001-&gt;0xa1）;要写入DA输出的数据的话，我们就需要使用地址为（1001_0000-&gt;0x90），要读取AD采样的数据的话，我们就需要使用地址为（1001_0001-&gt;0x91）</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603154239060.png"
	width="980"
	height="444"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603154239060_hu10083819465848639386.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240603154239060_hu6624154346038693339.png 1024w"
	loading="lazy"
	
		alt="image-20240603154239060"
	
	
		class="gallery-image" 
		data-flex-grow="220"
		data-flex-basis="529px"
	
></p>
<p>在我们使用IIC进行通信的时候，我们要遵循下面的运行逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="err">地址</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="err">功能</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ad与da">AD与DA
</h5><p>从上面说明的内容的我们可以知道，如果我们要对PCF8591进行操作，那么就需要对地址0x90和0x91进行操作</p>
<p>我们现在先说一下AD的代码，通过观察原理图我们可以发现，AD有4个通道可以进行读取</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604090624435.png"
	width="975"
	height="487"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604090624435_hu7260092772742088271.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604090624435_hu7321006441037096376.png 1024w"
	loading="lazy"
	
		alt="image-20240604090624435"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<p>其中AIN0通道是我们的外部测量通道（由于蓝桥杯现在还没有涉及到信号发生器，所以我们可以先暂时不用管这个通道）</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091125348.png"
	width="306"
	height="524"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091125348_hu16228381092733661131.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091125348_hu2781071736815709172.png 1024w"
	loading="lazy"
	
		alt="image-20240604091125348"
	
	
		class="gallery-image" 
		data-flex-grow="58"
		data-flex-basis="140px"
	
></p>
<p>AIN1通道很明显就是光敏电阻的分压读取（光照越强，分压越高，采集到的结果越大），</p>
<p>AIN2通道为差分输入（我们也是不常用到的输入，因为没有信号发生器）</p>
<p>AIN3通道为滑动变阻器输入（我们测量滑动变阻器的分压，这个你左右旋钮看一下就知道哪边变大了）</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091205128.png"
	width="1148"
	height="529"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091205128_hu7222732820390148188.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604091205128_hu6079059353803691260.png 1024w"
	loading="lazy"
	
		alt="image-20240604091205128"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="520px"
	
></p>
<p>我们查看一下PCF8591的手册可以看到，我们读取的地址的书写方式，这里我统一给一个说明</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:center">位次</th>
<th style="text-align:center">情况说明</th>
<th style="text-align:center">情况</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">第一位</td>
<td style="text-align:center">固定位</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">第二位</td>
<td style="text-align:center">是否需要开启DA输出</td>
<td style="text-align:center">开启DA输出（1）<br />不开启DA输出（0）</td>
</tr>
<tr>
<td style="text-align:center">第三四位</td>
<td style="text-align:center">选择输入通道的模式<br />差分输入具体要看下面的图</td>
<td style="text-align:center">通道与编号对应输入（常用）（00）<br />通道差分输入（01,10,11）</td>
</tr>
<tr>
<td style="text-align:center">第五位</td>
<td style="text-align:center">固定位</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">第六位</td>
<td style="text-align:center">自动递增标志<br />（用于一个一个读取AD输入口）</td>
<td style="text-align:center">自我递增（没考过，因为我们一般都是单一读取）（1）<br />不自我递增（0）</td>
</tr>
<tr>
<td style="text-align:center">第七八位</td>
<td style="text-align:center">用于指定我们读取的通道</td>
<td style="text-align:center">通道0（00），在我们正常的对应输入下为外部信号输入<br />通道1（01），在我们正常的对应输入下为光明电阻分压输入<br />通道2（10），在我们正常的对应输入下为差分信号输入<br />通道3，在我们正常的对应输入下为滑动变阻器分压输入（11）</td>
</tr>
</tbody>
</table></div>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604092329778.png"
	width="410"
	height="648"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604092329778_hu3748676254139716676.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604092329778_hu12860810829715906468.png 1024w"
	loading="lazy"
	
		alt="image-20240604092329778"
	
	
		class="gallery-image" 
		data-flex-grow="63"
		data-flex-basis="151px"
	
></p>
<p>我们那么这个时候常考的就是下面的形式，注意一下题目中是否需求DA输出，如果需要DA输出的话，这里使用地址的时候必须使用允许DA输出，</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:center">需要的数据</th>
<th style="text-align:center">输入的地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">外部电压输入（开启DA）</td>
<td style="text-align:center">0100_0000-&gt;0x40</td>
</tr>
<tr>
<td style="text-align:center">外部电压输入（不开启DA）</td>
<td style="text-align:center">0000_0000-&gt;0x00</td>
</tr>
<tr>
<td style="text-align:center">光敏电阻分压输入（开启DA）</td>
<td style="text-align:center">0100_0001-&gt;0x41</td>
</tr>
<tr>
<td style="text-align:center">光敏电阻分压输入（不开启DA）</td>
<td style="text-align:center">0000_0001-&gt;0x01</td>
</tr>
<tr>
<td style="text-align:center">差分信号输入（开启DA）</td>
<td style="text-align:center">0100_0010-&gt;0x42</td>
</tr>
<tr>
<td style="text-align:center">差分信号输入（不开启DA）</td>
<td style="text-align:center">0000_0010-&gt;0x02</td>
</tr>
<tr>
<td style="text-align:center">滑动变阻器分压输入（开启DA）</td>
<td style="text-align:center">0100_0011-&gt;0x43</td>
</tr>
<tr>
<td style="text-align:center">滑动变阻器分压输入（不开启DA）</td>
<td style="text-align:center">0000_0011-&gt;0x03</td>
</tr>
</tbody>
</table></div>
<p>有了这样一个基础，我们就可以开始着手编写我们的AD代码了</p>
<p>我们只需要指定一下我们需要读取的通道的地址就行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ad_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里给一个调用示例，这里需要注意的是，如果你同时读取光敏电阻和滑动变阻器的值，他们会地址交换，你们可以自己去试试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="nf">Ad_Read</span><span class="p">(</span><span class="mh">0x01</span><span class="p">);</span><span class="c1">//读取光敏电阻结果 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>首先我们需要选中我们的PCF芯片并且写入我们需要读取的地址,这里需要注意的就只有每次发送Byte后我们需要Wait一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 选择芯片为PCF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后重新开启一下通话（因为我们上面是进行写操作，现在要进行读操作），读取后我们需要发送一个Ack为1，表明我们这边接收数据完成，后续不用接受了，结束后就可以关闭对话Stop了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x91</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CStop</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AD完整代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ad_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 选择芯片为PCF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x91</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">temp</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>说完AD我们就要说到DA了</p>
<p>和AD一样，我们只需要传入我们需要写入的数据就行，但是要注意一下我们的数据为数字电压，即0-255，我们输出后的电压是模拟电压，即0-5V，所以我们是一一映射过去的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Da_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>举个🌰，我们如果想要输出电压为2V,那么我们就应该</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">Da_Write</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">51</span><span class="p">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果想要输出的电压为2.5V，那么我们就应该，这里不用关心他会出现不匹配的情况，C语言底层会自动转换为unsigned char类型的,这类有啊注意</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">Da_Write</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="mi">51</span><span class="p">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先我们需要选中我们的PCF芯片并且给他我们的地址信息（前面提到过如果要开启DA输出，那么我们应该写入的地址）,这里需要注意的就只有每次发送Byte后我们需要Wait一下，这里的0x41可以更换为0x40-0x43的任何一个，但是最好和题目中要求AD需要读取的通道一致（这里也要注意在你读取AD的时候加上0x4）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Da_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 选择芯片为PCF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AD与</p>
<h5 id="eeprom">EEPROM
</h5><p>从上面说明的内容的我们可以知道，如果我们要对AT24C02进行操作，那么就需要对地址0xa0和0xa1进行操作</p>
<p>本质上我们的EEPROM写入与读取和AD/DA是一致的，但是我们需要注意一个点，因为我们通常写入/读取的不止一个数据，我们一般是一个数组写进去和读取，所以我们就需要注意这个点，我们的操作如下，传递的数据都是数组的首地址（如果存单个数据只需要使用&amp;name就行），传入参数为需要写入/读取数组首地址名称））str，需要写入/读取的数组地址addr，数组的大小num</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里给一个调用的示例，需要注意一下如果写入为unsigned int，可以不用分为高低位存储，但是需要分为高低位读取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr_input</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr_output</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Write</span><span class="p">(</span><span class="n">arr_input</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Read</span><span class="p">(</span><span class="n">arr_output</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">output</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">high</span><span class="p">,</span><span class="n">low</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">high</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">EEPROM_Read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">low</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">high</span><span class="o">&lt;&lt;</span><span class="mi">4</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在我来说一下实现细节</p>
<p>先说明一下EEPROM_Read函数，和上文的AD读取一样，我们需要先选中AT24C02，并且功能为写，然后进行位置的传输，确认我们需要读取的地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在我们读取的时候，和上文AD一样，我们需要重新开启一个对话进行读取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是在我们读取的时候需要注意一个点，我们使用的数组进行的数据读取，并且在我们读取的时候对指针进行++操作，当我们还没有读完数据的时候，我们发送Ack为0，代表我们需要继续读取，当我们读取数据结束后，我们发送Ack为1，表示读取结束，最后也别忘记需要进行Stop停止交流。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CStop</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在这里说明一下*str++代表的含义，这是c的一个写法，等价于下面的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span><span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">-----</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>完整的代码EEPROM_READ如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以从上面看到，AD和EEPROM_READ可以进行类比；同理，我们的DA和EEPROM_Write也可以进行类比，但是EEPROM_Write有一个需要注意的点，我会在下面进行说明</p>
<p>我们第一步还是选择我们的芯片，选择我们需要写入的地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二步就是使用一个循环进行写入，这里需要注意一个问题，就是我们每写入一个数据，都需要I2C_Delay一下，注意不是Delay，而是I2C_Delay，经过我们测试，当这个值为200 的时候效果是可以的，并且这里有个最最重要的点，在我们Stop结束后，我们需要进行4个255时间的I2C_Delay~~（其实我在群里面说过，但你们一直觉得我在讲乐子）~~</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CSendByte</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整的代码EEPROM_Write如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CSendByte</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*	#   I2C代码片段说明
</span></span></span><span class="line"><span class="cl"><span class="cm">        1. 	本文件夹中提供的驱动代码供参赛选手完成程序设计参考。
</span></span></span><span class="line"><span class="cl"><span class="cm">        2.
</span></span></span><span class="line"><span class="cl"><span class="cm">   参赛选手可以自行编写相关代码或以该代码为基础，根据所选单片机类型、运行速度和试题
</span></span></span><span class="line"><span class="cl"><span class="cm">                中对单片机时钟频率的要求，进行代码调试和修改。
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;iic.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DELAY_TIME 5
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">scl</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">sda</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">I2C_Delay</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CStart</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CStop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CSendByte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">byt</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">I2CReceiveByte</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">da</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">da</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sda</span><span class="p">)</span> <span class="n">da</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">da</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">I2CWaitAck</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ackbit</span> <span class="o">=</span> <span class="n">sda</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">I2CSendAck</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ackbit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="n">ackbit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">scl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="n">DELAY_TIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ad_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 选择芯片为PCF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x91</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">temp</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 数字电压255-&gt;5V
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Da_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 选择芯片为PCF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CSendByte</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2C_Delay</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CSendByte</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CWaitAck</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="nf">I2CReceiveByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nf">I2CSendAck</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">I2CStop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="iich">iic.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ad_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Da_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">EEPROM_Read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">num</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="uart串口模版建立">Uart串口模版建立
</h2><h3 id="uartc">uart.c
</h3><p>在这里我们需要注意，串口官方是没有给底层的，我们需要自己手搓，在这里我给的代码为重定向代码。</p>
<p>首先是使用isp生成一个用定时器2计时的串口1的代码，波特率为9600（比赛的时候可能不是9600，要根据题目来看），定时器时钟选用12T，数据位为8位</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604144711333.png"
	width="1482"
	height="412"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604144711333_hu11756403422888296817.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604144711333_hu11376280965345764551.png 1024w"
	loading="lazy"
	
		alt="image-20240604144711333"
	
	
		class="gallery-image" 
		data-flex-grow="359"
		data-flex-basis="863px"
	
></p>
<p>我们直接把他复制到我们代码里面就行，最后别忘记加一个EA=1来开启总中断，还有些isp版本可能比较老，没有使能中断的选项，所以需要自己加上ES=1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart1_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">// 9600bps@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">SCON</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>   <span class="c1">// 8位数据,可变波特率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">AUXR</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>  <span class="c1">// 串口1选择定时器2为波特率发生器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">AUXR</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>  <span class="c1">// 定时器时钟1T模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">T2L</span> <span class="o">=</span> <span class="mh">0xC7</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">T2H</span> <span class="o">=</span> <span class="mh">0xFE</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">AUXR</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>  <span class="c1">// 定时器2开始计时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>        <span class="c1">// 使能串口1中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们这里不需要实现复杂的函数，只需要实现一个重定向就行，使用printf直接将数据发送到串口就行，我现在说一下步骤</p>
<p>我们通过查看c51里面（注意是c51，不是标准的c语言函数库，直接在keil里面右键打开），我们可以看到下方有一个putchar的一个extern的函数定义，这就是我们需要重载的函数，因为我们printf本质上就是调用putchar的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*--------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm">STDIO.H
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Prototypes for standard I/O functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.
</span></span></span><span class="line"><span class="cl"><span class="cm">All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm">--------------------------------------------------------------------------*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __STDIO_H__
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __STDIO_H__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef EOF
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define EOF -1
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef NULL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define NULL ((void *) 0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef _SIZE_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define _SIZE_T
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kt">size_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#pragma SAVE
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma REGPARMS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">extern</span> <span class="kt">char</span> <span class="nf">_getkey</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="nf">getchar</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="nf">ungetchar</span> <span class="p">(</span><span class="kt">char</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="nf">putchar</span> <span class="p">(</span><span class="kt">char</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">printf</span>   <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sprintf</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">vprintf</span>  <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">vsprintf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gets</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">scanf</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">sscanf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">int</span> <span class="nf">puts</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#pragma RESTORE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以知道，串口在发送的时候，会将数据放进缓冲区SBUF（如果你用串口2那就是S2BUF，但是这里没涉及到，就不用管了），当我们正在发送的时候TI标志位为0，当我们发送完成后，他就会被置为0，然后我们需要将ch返回（这个是函数本身就需要返回的char）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">char</span> <span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">SBUF</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">TI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="uarth">uart.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stdio.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">Uart1_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ul超声波模版建立">Ul超声波模版建立
</h2><h3 id="ulc">ul.c
</h3><p>在这里我们需要注意，超声波官方是没有给底层的，我们需要自己手搓。我们通过查询原理图可以看到，超声波的T为P10，R为P11，所以我们需要定义一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">Tx</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">Rx</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604151041554.png"
	width="816"
	height="198"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604151041554_hu14452358261305729515.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604151041554_hu17344670669342138933.png 1024w"
	loading="lazy"
	
		alt="image-20240604151041554"
	
	
		class="gallery-image" 
		data-flex-grow="412"
		data-flex-basis="989px"
	
></p>
<p>现在我们来进行逻辑的书写，我们首先要知道超声波测距的原理，我发送数据后，等待接收数据，那么我通过计算发送和接收中的间隔时间，就可以得到我们的距离，这里用数学公式可以进行计算，一般来说声速都是340m/s（也不排除题目里面和你说要对其进行变换啥的【比如第十四届国赛】，这里就按照声速为340m/s来进行说明）</p>
<p>$$
d = {{vt} \over 2} = {{340m/s<em>t} \over 2} = 170m/s</em>t = 1.7*{10^4}cm/s*t
$$</p>
<p>我们这里有一个单位换算需要进行注意，t的单位为us，也就是</p>
<p>title: Chinese Test
description: 这是一个副标题
date: 2020-09-09
slug: test-chinese
image: helena-hertz-wWZzXlDpMog-unsplash.jpg
categories:
- Test
- 测试</p>
<p>$$
{10^{ - 6}}s
$$</p>
<p>$$
d = 1.7*{10^4}*{10^{ - 6}}t = 0.017t
$$</p>
<p>图来自微信群友chmod-wrx绘制（我绘图太🌶︎🐔了）</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153314869.png"
	width="1004"
	height="500"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153314869_hu9314416907941130624.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153314869_hu16196272913627774531.png 1024w"
	loading="lazy"
	
		alt="image-20240604153314869"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="481px"
	
></p>
<p>根据我们上方的分析，我们可以知道我们首先需要进行发送，我们在这里发送8个40kHz的方波进行测量，那么周期就是</p>
<p>$$
{1 \over {40k}} = 25 \cdot {10^{ - 6}}s = 25us
$$</p>
<p>，也就是我们需要$12us$将发送的电平进行反转</p>
<p>代码如下，我们首先使用isp生成一个12us的延时函数,这里需要注意的是要正确使用系统频率为12MHz；如果这里测量结果有问题，可以尝试将33修改为38或者其他的数据，因为软件延时不准。</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153718702.png"
	width="714"
	height="459"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153718702_hu14742700002834635838.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604153718702_hu18384957598708163223.png 1024w"
	loading="lazy"
	
		alt="image-20240604153718702"
	
	
		class="gallery-image" 
		data-flex-grow="155"
		data-flex-basis="373px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Delay12us</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>	<span class="c1">//@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span><span class="c1">//可以修改为其他数据，比如38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后就是我们的超声波发送函数，发送8个4kHz的方波</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Ut_Wave_Init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay12us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay12us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后是我们最重要的数据接收与转换函数的书写，在这里我们使用的pca定时器，可以节省定时器来进行其他的操作（因为ne555强制占用定时器0，串口考到就会占用一个定时器，还有一个定时器需要用来进行函数轮询，所以我们就必须用其他的定时器进行超声波的操作）,其实PCA本质上还是一个定时器，所以他也存在一些定时器的参数，比如TLx-&gt;CL;THx-&gt;CH;TMOD-&gt;CMOD;TRx-&gt;CR;TFx-&gt;CF</p>
<p>我们首先需要对定时器的CH和CL清零，为了我们计数做准备；然后将CMOD配置为0x00，十六位不重载定时器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">CH</span> <span class="o">=</span> <span class="n">CL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">CMOD</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在我们发送超声波的时候，我们需要将总中断关闭，在我们发送完毕后就关掉，在我们发送完成后，就打开CR开始计时，等待我们收到回应（收到回应后Rx为0）或者计数溢出（溢出后CF为1），我们就关闭CR开始读取数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">EA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">Ut_Wave_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">Rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">CR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果我们是因为收到回应而结束（那么就代表我们测量到了数据），那么我们就进行时间读取，如下所示，你们可能会好奇为什么+3，这是因为我们实际测量发现，+3后在远程数据（测量结果&gt;10的时候）误差会比较小，而近程数据（测量数据&lt;10）满足误差范围，我们也不可能测量得到0这个数据（题目中一般都不会测到0）（所以我们才把他视为测量错误的返回结果）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">time</span> <span class="o">=</span> <span class="n">CH</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">CL</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="p">(</span><span class="mf">0.017</span> <span class="o">*</span> <span class="n">time</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果我们是因为计数溢出（没有收到返回的信号，代表测量错误），我们就直接返回为0，表示错误结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>转换的完整代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ut_Wave_Data</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CH</span> <span class="o">=</span> <span class="n">CL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CMOD</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Ut_Wave_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">CR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">Rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">CR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CF</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// us -&gt; s 10^(-6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// m -&gt; cm 10^2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  10^(-4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// L = V*T/2=340*time/2=170*10^(-4)*time=0.017*time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">time</span> <span class="o">=</span> <span class="n">CH</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">CL</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mf">0.017</span> <span class="o">*</span> <span class="n">time</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ul.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">sbit</span> <span class="n">Tx</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">sbit</span> <span class="n">Rx</span> <span class="o">=</span> <span class="n">P1</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Delay12us</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">//@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>  <span class="c1">// 38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Ut_Wave_Init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay12us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay12us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ut_Wave_Data</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CH</span> <span class="o">=</span> <span class="n">CL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CMOD</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Ut_Wave_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">CR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">Rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CF</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">CR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CF</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// us -&gt; s 10^(-6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// m -&gt; cm 10^2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  10^(-4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// L = V*T/2=340*time/2=170*10^(-4)*time=0.017*time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">time</span> <span class="o">=</span> <span class="n">CH</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">CL</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mf">0.017</span> <span class="o">*</span> <span class="n">time</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ulh">ul.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">Ut_Wave_Data</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="init初始化模版建立">init初始化模版建立
</h2><h3 id="initc">init.c
</h3><p>我们在启动开发板的时候最好对其进行初始化，关闭蜂鸣器和继电器，MOTOR和全部LED灯，避免上电情况有误</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;init.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">System_Init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">P0</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">P0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">=</span> <span class="n">P2</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">P2</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="inith">init.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">System_Init</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="main主函数书写">main主函数书写
</h2><h3 id="mainc">main.c
</h3><p>现在我们来进行主函数的编写，我也拆分为模块，但是最后还是会给一个整体的代码</p>
<h4 id="全部变量的归纳">全部变量的归纳
</h4><p>这里我把全部的全局变量放上来</p>
<blockquote>
<ul>
<li>定义了Led的变量数组，用于控制8个灯的亮灭情况</li>
<li>定义了Seg_Pos的变量，用于控制数码管位选情况</li>
<li>定义了Seg_Buf的变量数组，用于控制每个数码管显示第数据</li>
<li>定义了Seg_Point的变量数组，用于控制某一位数码管是否显示小数点</li>
<li>定义了Uart_Buf的变量数组，用于获取串口接收的数据</li>
<li>定义了Uart_Rx_Index的变量，用于对串口接收后的数组进行索引</li>
<li>定义了Uart_flag的变量，用于判断当前是否正处于串口接收状态</li>
<li>定义了Sys_Tick的变量，用于嘀嗒计时，判断串口是否接收状态超过了10ms</li>
<li>定义了ucRtc的变量数组，用于存放时钟数据，时分秒</li>
<li>定义了int型的计时变量time_all_1s，用于全局定时</li>
<li>定义了int型的频率变量Freq，用于测频结果的存放</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* LED与数码管 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucLed</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Point</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 串口数据*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Uart_Buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Uart_Rx_Index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">bit</span> <span class="n">Uart_flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sys_Tick</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 时间*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucRtc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_all_1s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 数据 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Freq</span><span class="p">;</span><span class="c1">//ne555测频
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="数据读取模块">数据读取模块
</h4><p>我们单独写一个模块对数据进行读取，方便我们进行不同数据的操作，这里使用%的操作来进行时间的定时，比如我们的时间读取，就每隔50ms（因为我定时器是1ms）进行一次；AD读取每隔100ms一次；温度读取每隔500ms一次（这里仅作参考，后续还是要自己搓一下试试）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Data_Proc</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 时间读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// AD读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 温度读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="key键盘模块">Key键盘模块
</h4><p>这个模块是重中之重，因为用到了一个很精妙的三行代码消抖方法，这个在我以前的视频<a class="link" href="https://www.bilibili.com/video/BV1Cx421y7qn/"  target="_blank" rel="noopener"
    >蓝桥杯单片机按键考点</a>里面提到过，点击这行字体就可以跳转过去，我这里简单说明一下，我们的逻辑如下，Key_Val,Key_Old,Key_Down,Key_Up,这几个变量都是下面的逻辑，我们这里对其的原理进行解析</p>
<blockquote>
<p>瞬时值获取-&gt; 获取按下的值，获取抬起的值-&gt;更新⼀下值</p>
<p>Down和Up都是瞬时值，Old比Val延后10ms，基于这个特性我们可以进行书写代码</p>
</blockquote>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604200625869.png"
	width="843"
	height="454"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604200625869_hu6146236961758104066.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604200625869_hu17019617813155669326.png 1024w"
	loading="lazy"
	
		alt="image-20240604200625869"
	
	
		class="gallery-image" 
		data-flex-grow="185"
		data-flex-basis="445px"
	
></p>
<p>对应的代码如下，我们将这四个变量设置为静态局部变量，可以有效节省内存空间，使用if语句那一段表明我们选择10ms跑一次代码（因为我们定时是1ms的）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Key_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Key_Val</span><span class="p">,</span> <span class="n">Key_Down</span><span class="p">,</span> <span class="n">Key_Up</span><span class="p">,</span> <span class="n">Key_Old</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Val</span> <span class="o">=</span> <span class="nf">Key_Read</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Down</span> <span class="o">=</span> <span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Up</span> <span class="o">=</span> <span class="o">~</span><span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Old</span> <span class="o">=</span> <span class="n">Key_Val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果理解不了上面的图和代码，我就拿一个🌰来进行验证，比如我们按下/抬起S4来做一下验证</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:center">键盘状态</th>
<th style="text-align:center">Key_Old</th>
<th style="text-align:center">Key_Val</th>
<th style="text-align:center">Key_Old^Key_Val</th>
<th style="text-align:center">Key_Down</th>
<th style="text-align:center">Key_Up</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">未按下</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0000^0000=0000</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0000</td>
</tr>
<tr>
<td style="text-align:center">按下过程中（10ms）</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0100</td>
<td style="text-align:center">0000^0100=0100</td>
<td style="text-align:center">0100&amp;0100=0100</td>
<td style="text-align:center">1011&amp;0100=0000</td>
</tr>
<tr>
<td style="text-align:center">按下稳定（10ms后）</td>
<td style="text-align:center">0100</td>
<td style="text-align:center">0100</td>
<td style="text-align:center">0100^0100=0000</td>
<td style="text-align:center">0100&amp;0000=0000</td>
<td style="text-align:center">1011&amp;0000=0000</td>
</tr>
<tr>
<td style="text-align:center">抬起过程（10ms）</td>
<td style="text-align:center">0100</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0100^0000=0100</td>
<td style="text-align:center">0000&amp;0100=0000</td>
<td style="text-align:center">1111&amp;0100=0100</td>
</tr>
</tbody>
</table></div>
<p>我们可以从这里看出，当我们按下的时候，那一瞬间Down会是4（注意是一瞬间），其余时候都是0；同理Up也是一样，当我们抬起的瞬间Up会是4（注意是一瞬间），其余时候是0</p>
<p>那么我们如何在这个代码里面进行书写呢，其实很简单，我们一般判断按键都是判断的按键按下，即Down的数据，那么我们按照下面这样写就行，下面就是按下S4的一个示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Key_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Key_Val</span><span class="p">,</span> <span class="n">Key_Down</span><span class="p">,</span> <span class="n">Key_Up</span><span class="p">,</span> <span class="n">Key_Old</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Key_Val</span> <span class="o">=</span> <span class="nf">Key_Read</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Key_Down</span> <span class="o">=</span> <span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Key_Up</span> <span class="o">=</span> <span class="o">~</span><span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Key_Old</span> <span class="o">=</span> <span class="n">Key_Val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">Key_Down</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行按下S4的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="seg数码管模块">Seg数码管模块
</h4><p>这个和V2模版不一样，他将数据读取放出去了，所以我们的数码管里面不过多涉及到数据读取，这里选择的是20ms进行一次数码管状态更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Seg_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如何使用呢，其实也非常简单，我们只需要按照下方的写法即可（因为一般来说我们都有多个界面进行切换，我们定义一个变量Seg_Show_Mode来进行书写，如果有子界面的话，拿我们就再定义一个mode就行）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Seg_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span><span class="p">(</span><span class="n">Seg_Show_Mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//xx界面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Seg_Buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Seg_Buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//xx界面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="led灯模块">Led灯模块
</h4><p>这里面我的话经常放的是Led，蜂鸣器，继电器，MOTOR口的相关逻辑，这里不需要设置定时进入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Led_Proc</span><span class="p">()</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用示例如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Led_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ucLed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//L1点亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ucLed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//L2熄灭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Relay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//打开继电器（L10亮）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Beep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//蜂鸣器开启
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOTOR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//MOTOR输出高电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Relay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//关闭继电器（L10灭）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Beep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//蜂鸣器关闭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOTOR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//MOTOR输出低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="uart串口模块">Uart串口模块
</h4><p>我们在这里使用了串口超时解析，即10ms内没有收集到串口的信息的时候我们才进入并进行解析（后续在定时器里面会提到这个Sys_Tick），在我们解析结束后使用memset函数将接收的数组置为0（为了防止后续解析被干扰），并将索引置为0，为下一次接收解析进行准备</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_Rx_Index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Sys_Tick</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sys_Tick</span> <span class="o">=</span> <span class="n">Uart_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">Uart_Buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Uart_Rx_Index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Rx_Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用示例，这里发送小写的ok返回hello，注意一下，判断的时候用的是单引号而不是双引号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_Rx_Index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Sys_Tick</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sys_Tick</span> <span class="o">=</span> <span class="n">Uart_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">Uart_Buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;o&#39;</span><span class="o">&amp;&amp;</span><span class="n">Uart_Buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;k&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">Uart_Buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Uart_Rx_Index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Rx_Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="定时器0初始化ne555模块">定时器0初始化（NE555模块）
</h4><p>这个模块是最有意思的，首先我们需要注意一下，P34和singal的跳线帽要插在一起，并且按键方面需要删除P34，然后才能开始测，这里依然用isp生成一下初始化的定时器0，但是这里要注意，新版的不能生成0ms，我们就随便生成个时间，然后按照我这样勾选后复制粘贴就行</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604202942361.png"
	width="731"
	height="383"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604202942361_hu17240632272316830668.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604202942361_hu13846217410951800472.png 1024w"
	loading="lazy"
	
		alt="image-20240604202942361"
	
	
		class="gallery-image" 
		data-flex-grow="190"
		data-flex-basis="458px"
	
></p>
<p>我们需要将TL0和TH0的值改为0，并且在TMOD &amp;= 0xF0;下面对其进行配置  TMOD |= 0x05;将其变为十六位不自动重载（这里具体可以参考手册里面对于定时器的配置，我之前的视频有提到<a class="link" href="https://www.bilibili.com/video/BV1Fk4y1f7LS/"  target="_blank" rel="noopener"
    >蓝桥杯单片机ne555模块</a>，点击即可观看），这里别忘了EA开启总中断（这是我的习惯），频率的读取放在定时器1那里讲</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer0_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">// 1毫秒@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AUXR</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>  <span class="c1">// 定时器时钟12T模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>  <span class="c1">// 设置定时器模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">|=</span> <span class="mh">0x05</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TL0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TH0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TF0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 清除TF0标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TR0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// 定时器0开始计时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="定时器1初始化">定时器1初始化
</h4><p>这是我们轮询的定时器的初始化代码，我们使用isp生成1ms定时器1的代码（记得勾选上使能），老版本没有使能，所以记得加上ET1 = 1开启</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604203409782.png"
	width="731"
	height="383"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604203409782_hu4946994458120863633.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604203409782_hu13448468403095860179.png 1024w"
	loading="lazy"
	
		alt="image-20240604203409782"
	
	
		class="gallery-image" 
		data-flex-grow="190"
		data-flex-basis="458px"
	
></p>
<p>当然，不要忘记EA = 1，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer1_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">// 1毫秒@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AUXR</span> <span class="o">&amp;=</span> <span class="mh">0xBF</span><span class="p">;</span>  <span class="c1">// 定时器时钟12T模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>  <span class="c1">// 设置定时器模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TL1</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TH1</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TF1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// 清除TF1标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TR1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// 定时器1开始计时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ET1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// 使能定时器1中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="定时器1中断重点">定时器1中断（重点）
</h4><p>我们在这里放了一堆东西，这里我做一下说明，我们每个中断都有对应的中断号（可以在官方的手册查到），这里定时器1的中断号是3</p>
<p>然后是我们的一个全局定时器（1s，注意time_all_1s的类型要是unsigned int，不然会溢出），在这个定时器里面我们对频率进行了读取，将TH0 &laquo; 8 | TL0的结果给了Freq（注意一下Freq的类型要是unsigned int，不然会溢出），在我们读取完数据后，将TH0和TL0进行了置0手动重载，方便下一次进行测量</p>
<p>接着就是一个和Sys_Tick相关的代码，当我们接收到数据的时候Uart_flag会置为1，然后将Sys_Tick置为0，也就是说我们一段时间不接受数据的话，那么Sys_Tick的值会一直累加，直到达到10ms（我们上面在Uart串口模块里面的设定），Uart_flag置为0，Sys_Tick的值置为0，为下一轮串口解析做准备</p>
<p>然后就是我们的一个位选的代码，因为我们数码管本质上是一位一位显示，所以我们需要写一个位选的变量来进行位选，这里使用的Seg_Pos = (++Seg_Pos) % 8将Seg_Pos这个变量在0~7中间进行循环</p>
<p>接着就是我们的数码管显示函数，这里不需要多说了，保持他不变就行，传入为位选、位选对应的段选显示、位选对应的小数点显示</p>
<p>最后就是我们的Led显示函数，这里我并没有选择和数码管同步，而是选择在中断里面写了个for循环来进行显示，因为它不涉及到扫描等操作，本质上就是可以直接一起显示。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer1_Isr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">interrupt</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">time_all_1s</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_all_1s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Freq</span> <span class="o">=</span> <span class="n">TH0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">TL0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TH0</span> <span class="o">=</span> <span class="n">TL0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_flag</span><span class="p">)</span> <span class="n">Sys_Tick</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Seg_Pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">Seg_Pos</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Seg_Disp</span><span class="p">(</span><span class="n">Seg_Pos</span><span class="p">,</span> <span class="n">Seg_Buf</span><span class="p">[</span><span class="n">Seg_Pos</span><span class="p">],</span> <span class="n">Seg_Point</span><span class="p">[</span><span class="n">Seg_Pos</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">Led_Disp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ucLed</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="串口中断这里代码写死">串口中断（这里代码写死）
</h4><p>我们串口有一个接收中断，串口1的中断号查询后发现为4</p>
<p>我们第一行就是判断是否RI为1，因为RI为1则代表有信息过来了，当我们收集到信息时，我们将Uart_flag置为1，Sys_Tick置为0，开始嘀嗒计时，当我们10ms没有接收到新的数据的时候，我们就认为数据接收完成，可以开始进行串口处理，后面的接收就不需要多讲了，我们是一位一位进行接收的，而读写都是用的SBUF这个缓冲区（串口1，如果是串口2则是S2BUF，但是串口2不会考，所以这里不用管），我们接收完成后，将RI置为0，为下一次接收做准备，最后一行的&gt;10清零，则是为了避免出现传入数据溢出，导致程序异常，这里的10取决于你的字符串数组的位数，我在最上面定的是10位，所以这里写的10</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart1_Isr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">interrupt</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">RI</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sys_Tick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Buf</span><span class="p">[</span><span class="n">Uart_Rx_Index</span><span class="p">]</span> <span class="o">=</span> <span class="n">SBUF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Rx_Index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_Rx_Index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="n">Uart_Rx_Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="main主函数书写-1">main主函数书写
</h4><p>这是我们的一个最初的函数，没什么好说明的，就是需要进行一些初始化而已，但是顺序不要写错了，首先是系统初始化，然后是定时器0（ne555），最后是定时器1（轮询）的初始化。</p>
<p>你可以发现，我在这里进行了一次温度的空读取，因为温度上电后会显示85（温度转换的时间），如果在后面才给他开始温度转换的话，那么很有可能跳85，导致测量结果错误，这里的延时函数也是用isp直接生成的，注意系统时间别选错了就行</p>
<p><img src="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604205532498.png"
	width="756"
	height="432"
	srcset="/p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604205532498_hu1746395583063691776.png 480w, /p/%E8%93%9D%E6%A1%A5%E6%9D%AF/image-20240604205532498_hu15138503547430193312.png 1024w"
	loading="lazy"
	
		alt="image-20240604205532498"
	
	
		class="gallery-image" 
		data-flex-grow="175"
		data-flex-basis="420px"
	
></p>
<p>我们写完初始化之后就需要写一下循环了，51单片机里面必须将循环写死，所以我们用了while(1)，这里的顺序倒没什么特殊的要求，但是尽量按照我这个顺序就行，不会出问题的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">System_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Timer0_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Timer1_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Set_Rtc</span><span class="p">(</span><span class="n">ucRtc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">rd_temperature</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delay750ms</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Data_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Key_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Seg_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Uart_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Led_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="完整的mainc">完整的main.c
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;main.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* LED与数码管 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucLed</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Seg_Point</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 串口数据*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Uart_Buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Uart_Rx_Index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">bit</span> <span class="n">Uart_flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sys_Tick</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 时间*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ucRtc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_all_1s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 数据 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Freq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Data_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 时间读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// AD读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 温度读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 键盘处理*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Key_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Key_Val</span><span class="p">,</span> <span class="n">Key_Down</span><span class="p">,</span> <span class="n">Key_Up</span><span class="p">,</span> <span class="n">Key_Old</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Val</span> <span class="o">=</span> <span class="nf">Key_Read</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Down</span> <span class="o">=</span> <span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Up</span> <span class="o">=</span> <span class="o">~</span><span class="n">Key_Val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Key_Old</span> <span class="o">^</span> <span class="n">Key_Val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_Old</span> <span class="o">=</span> <span class="n">Key_Val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 数码管处理*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Seg_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">time_all_1s</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Led_Proc</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart_Proc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_Rx_Index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Sys_Tick</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sys_Tick</span> <span class="o">=</span> <span class="n">Uart_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">Uart_Buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Uart_Rx_Index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Rx_Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer0_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">// 1毫秒@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AUXR</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>  <span class="c1">// 定时器时钟12T模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>  <span class="c1">// 设置定时器模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">|=</span> <span class="mh">0x05</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TL0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TH0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TF0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 清除TF0标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TR0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// 定时器0开始计时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer1_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">// 1毫秒@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AUXR</span> <span class="o">&amp;=</span> <span class="mh">0xBF</span><span class="p">;</span>  <span class="c1">// 定时器时钟12T模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TMOD</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>  <span class="c1">// 设置定时器模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TL1</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TH1</span> <span class="o">=</span> <span class="mh">0xFC</span><span class="p">;</span>    <span class="c1">// 设置定时初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TF1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// 清除TF1标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TR1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// 定时器1开始计时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ET1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// 使能定时器1中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">EA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Timer1_Isr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">interrupt</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">time_all_1s</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_all_1s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Freq</span> <span class="o">=</span> <span class="n">TH0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">TL0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TH0</span> <span class="o">=</span> <span class="n">TL0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_flag</span><span class="p">)</span> <span class="n">Sys_Tick</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Seg_Pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">Seg_Pos</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Seg_Disp</span><span class="p">(</span><span class="n">Seg_Pos</span><span class="p">,</span> <span class="n">Seg_Buf</span><span class="p">[</span><span class="n">Seg_Pos</span><span class="p">],</span> <span class="n">Seg_Point</span><span class="p">[</span><span class="n">Seg_Pos</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">Led_Disp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ucLed</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Uart1_Isr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">interrupt</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">RI</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sys_Tick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Buf</span><span class="p">[</span><span class="n">Uart_Rx_Index</span><span class="p">]</span> <span class="o">=</span> <span class="n">SBUF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uart_Rx_Index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">Uart_Rx_Index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="n">Uart_Rx_Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Delay750ms</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>  <span class="c1">//@12.000MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_nop_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">i</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="mi">51</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">k</span> <span class="o">=</span> <span class="mi">182</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">j</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">System_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Timer0_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Timer1_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Set_Rtc</span><span class="p">(</span><span class="n">ucRtc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">rd_temperature</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Delay750ms</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Data_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Key_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Seg_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Uart_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Led_Proc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mainh">main.h
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;STC15F2K60S2.H&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ds1302.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;iic.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;init.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;intrins.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;key.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;led.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;onewire.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;seg.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stdio.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;string.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;uart.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;ul.h&#34;</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Example Person
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<script
  src="https://npm.elemecdn.com/nprogress@0.2.0/nprogress.js"
  crossorigin="anonymous"
></script>
<link
  rel="stylesheet"
  href="https://npm.elemecdn.com/nprogress@0.2.0/nprogress.css"
  crossorigin="anonymous"
/>
<script>
  NProgress.start();
  document.addEventListener("readystatechange", () => {
    if (document.readyState === "interactive") NProgress.inc(0.8);
    if (document.readyState === "complete") NProgress.done();
  });
</script>

    </body>
</html>
